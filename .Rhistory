m_max <- apply(m_net_benefit, c(2,3), which.max)
plot(wtp_seq, apply(m_max == 2, 2, mean), type = "l", ylim = c(0,1))
m_max
### Cost-Effectiveness Acceptability Curve
m_max <- apply(m_net_benefit, c(1,3), which.max)
plot(wtp_seq, apply(m_max == 2, 2, mean), type = "l", ylim = c(0,1))
ceac.plot(model_bcea)
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
### Baseline willingness to pay = 20000
baseline_wtp <- which(wtp_seq == 20000)
# Average net benefit
mean_net_benefit <- apply(m_net_benefit[, , baseline_wtp], 2, mean)
mean_net_benefit
# Optimal treatment
d_star <-  which.max(mean_net_benefit)
d_star
### Baseline willingness to pay = 20000
baseline_wtp <- which(wtp_seq == 20000)
baseline_wtp
# Average net benefit
mean_net_benefit <- apply(m_net_benefit[, , baseline_wtp], 2, mean)
mean_net_benefit
mean_net_benefit
# Optimal treatment
d_star <-  which.max(mean_net_benefit)
d_star
d_star
### Run the Model
source("04_analysis/01_model_run.R")
m_costs_effects[, c(3, 4)]
m_costs_effects[, c(1, 2)]
### Run the Model
source("04_analysis/01_model_run.R")
library(BCEA)
model_bcea <- bcea(m_costs_effects[, c(3, 4)],
m_costs_effects[, c(1, 2)], ref = 2)
plot(model_bcea)
ceac.plot(model_bcea)
### Baseline willingness to pay = 20000
baseline_wtp <- which(wtp_seq == 20000)
# Average net benefit
mean_net_benefit <- apply(m_net_benefit[, , baseline_wtp], 2, mean)
mean_net_benefit
# Optimal treatment
d_star <-  which.max(mean_net_benefit)
d_star
### Cost-Effectiveness Acceptability Curve
m_max <- apply(m_net_benefit, c(1,3), which.max)
plot(wtp_seq, apply(m_max == 2, 2, mean), type = "l", ylim = c(0,1))
m_costs_effects
model_bcea <- bcea(m_costs_effects[, c("eff1", "eff2")],
m_costs_effects[, c("cost1", "cost2")], ref = 2)
plot(model_bcea)
ceac.plot(model_bcea)
apply(m_net_benefit[, , baseline_wtp], 2, mean)
m_net_benefit[, , baseline_wtp]
m_costs_effects[, c("eff1", "eff2")]
m_costs_effects[, c("eff1", "eff2")] * 20000 - m_costs_effects[, c("cost1", "cost2")]
m_costs_effects[, c("eff1", "eff2")] * 20000
m_costs_effects[, c("cost1", "cost2")]
################################################################################
#### Analysis for the Chemotherapy Example
################################################################################
rm(list = ls())
set.seed(123)
### Load the Inputs
source("02_data/01_data_inputs.R")
source("02_data/02_Assumption_Inputs.R")
### Load the Functions
source("03_R/01_misc_functions.R")
source("03_R/02_model_functions.R")
### Generate the parameters for the PSA
n_psa_size <- 5000
m_params <- generate_psa_parameters(n_psa_size)
### Run the model
m_costs_effects <- array(NA, dim = c(n_psa_size, 4))
for(s in 1:n_psa_size){
v_params <- m_params[s, ]
v_params <- c(v_params,
n_population = n_population,
time_horizon = time_horizon)
m_costs_effects[s, ] <- do.call(calculate_costs_effects,
v_params[names(formals(calculate_costs_effects))])
}
# Set the column names for the output
colnames(m_costs_effects) <- names(
do.call(calculate_costs_effects,
v_params[names(formals(calculate_costs_effects))])
)
# Estimate net benefit for different willingness-to-pay values
n_wtp <- 501
wtp_seq <- seq(0, 50000, length.out = n_wtp)
# Initialise the net benefit matrix
m_net_benefit <- array(NA, dim = c(n_psa_size, 2, n_wtp))
w <- 1
wtp
wtp <- 20000
calculate_net_benefit(m_costs_effects, wtp = wtp)
w <- 1
for(wtp in seq_along(wtp_seq)){
m_net_benefit[ , , w] <- calculate_net_benefit(m_costs_effects, wtp = wtp)
w <- w + 1
}
m_net_benefit[ , , 201]
wtp
m_net_benefit <- array(NA, dim = c(n_psa_size, 2, n_wtp))
w <- 1
for(wtp in wtp_seq){
m_net_benefit[ , , w] <- calculate_net_benefit(m_costs_effects, wtp = wtp)
w <- w + 1
}
m_net_benefit
### Baseline willingness to pay = 20000
baseline_wtp <- which(wtp_seq == 20000)
# Average net benefit
mean_net_benefit <- apply(m_net_benefit[, , baseline_wtp], 2, mean)
mean_net_benefit
# Optimal treatment
d_star <-  which.max(mean_net_benefit)
d_star
### Cost-Effectiveness Acceptability Curve
m_max <- apply(m_net_benefit, c(1,3), which.max)
plot(wtp_seq, apply(m_max == 2, 2, mean), type = "l", ylim = c(0,1))
### Incremental Cost-Effectiveness Ratio (ICER)
ICER <- m_costs_effects[, c("cost1")] - m_costs_effects[, c("cost2")] /
m_costs_effects[, c("effs1")] - m_costs_effects[, c("effs2")]
names(m_costs_effects)
colnames(m_costs_effects)
### Incremental Cost-Effectiveness Ratio (ICER)
ICER <- m_costs_effects[, c("cost1")] - m_costs_effects[, c("cost2")] /
m_costs_effects[, c("eff1")] - m_costs_effects[, c("eff2")]
ICER
### Incremental Cost-Effectiveness Ratio (ICER)
ICER <- mean(m_costs_effects[, c("cost1")] - m_costs_effects[, c("cost2")]) /
mean(m_costs_effects[, c("eff1")] - m_costs_effects[, c("eff2")])
ICER
### Mean costs and effects
apply(m_costs_effects, 2, mean)
### Mean costs and effects
mean_costs_effects <- apply(m_costs_effects, 2, mean)
### Cost-Effectiveness Acceptability Frontier
points(wtp_seq, apply(m_max == 1, 2, mean), type = "l", col = "red")
apply(m_net_benefit, c(2,3), mean)
apply(apply(m_net_benefit, c(2,3), mean), 2, which.max)
### Cost-Effectiveness Acceptability Frontier
m_ceaf <- cbind(apply(m_max == 1, 2, mean), apply(m_max == 2, 2, mean))
m_ceaf
apply(apply(m_net_benefit, c(2,3), mean), 2, which.max)
v_optimal_treatment <- apply(apply(m_net_benefit, c(2,3), mean), 2, which.max)
plot(wtp_seq, m_ceaf[, 2], type = "l", ylim = c(0,1))
points(wtp_seq, m_ceaf[, 1], type = "l", col = "red")
v_optimal_treatment <- apply(apply(m_net_benefit, c(2,3), mean), 2, which.max)
v_optimal_treatment
m_ceaf[v_optimal_treatment, 1:n_wtp]
m_ceaf[1:n_wtp, v_optimal_treatment]
m_ceaf
for(i in 1:n_wtp){
v_ceaf[i] <- m_ceaf[i, v_optimal_treatment[i]]
}
v_optimal_treatment <- apply(apply(m_net_benefit, c(2,3), mean), 2, which.max)
v_ceaf <- vector(NA, length = n_wtp)
for(i in 1:n_wtp){
v_ceaf[i] <- m_ceaf[i, v_optimal_treatment[i]]
}
v_ceaf <- vector(length = n_wtp)
for(i in 1:n_wtp){
v_ceaf[i] <- m_ceaf[i, v_optimal_treatment[i]]
}
v_ceaf
points(wtp_seq, v_ceaf)
### Cost-Effectiveness Acceptability Frontier
m_ceaf <- cbind(apply(m_max == 1, 2, mean), apply(m_max == 2, 2, mean))
plot(wtp_seq, m_ceaf[, 2], type = "l", ylim = c(0,1))
points(wtp_seq, m_ceaf[, 1], type = "l", col = "red")
v_optimal_treatment <- apply(apply(m_net_benefit, c(2,3), mean), 2, which.max)
v_ceaf <- vector(length = n_wtp)
for(i in 1:n_wtp){
v_ceaf[i] <- m_ceaf[i, v_optimal_treatment[i]]
}
points(wtp_seq, v_ceaf, type = ".")
points(wtp_seq, v_ceaf, pch = ".")
points(wtp_seq, v_ceaf, pch = 19, cex = 0.5)
### Run the Model
source("04_analysis/01_model_run.R")
### Mean costs and effects
mean_costs_effects <- apply(m_costs_effects, 2, mean)
### Incremental Cost-Effectiveness Ratio (ICER)
ICER <- mean(m_costs_effects[, c("cost1")] - m_costs_effects[, c("cost2")]) /
mean(m_costs_effects[, c("eff1")] - m_costs_effects[, c("eff2")])
ICER
mean_costs_effects
ICER
### Cost-Effectiveness Acceptability Curve
m_max <- apply(m_net_benefit, c(1,3), which.max)
plot(wtp_seq, apply(m_max == 2, 2, mean), type = "l", ylim = c(0,1))
### Cost-Effectiveness Acceptability Frontier
m_ceaf <- cbind(apply(m_max == 1, 2, mean), apply(m_max == 2, 2, mean))
plot(wtp_seq, m_ceaf[, 2], type = "l", ylim = c(0,1))
points(wtp_seq, m_ceaf[, 1], type = "l", col = "red")
v_optimal_treatment <- apply(apply(m_net_benefit, c(2,3), mean), 2, which.max)
v_ceaf <- vector(length = n_wtp)
for(i in 1:n_wtp){
v_ceaf[i] <- m_ceaf[i, v_optimal_treatment[i]]
}
points(wtp_seq, v_ceaf, pch = 19, cex = 0.5)
### Baseline willingness to pay = 20000
baseline_wtp <- which(wtp_seq == 20000)
# Average net benefit
mean_net_benefit <- apply(m_net_benefit[, , baseline_wtp], 2, mean)
mean_net_benefit
# Optimal treatment
d_star <-  which.max(mean_net_benefit)
d_star
tab_mean_costs_effects <- matrix(mean_costs_effecs, nrow = 2, ncol = 2)
### Mean costs and effects
mean_costs_effects <- apply(m_costs_effects, 2, mean)
tab_mean_costs_effects <- matrix(mean_costs_effecs, nrow = 2, ncol = 2)
tab_mean_costs_effects <- matrix(mean_costs_effects, nrow = 2, ncol = 2)
tab_mean_costs_effects
colnames(tab_mean_costs_effects) <- c("Costs", "Effects")
rownames(tab_mean_costs_effects) <- c("Treatment 1", "Treatment 2")
tab_mean_costs_effects
write.csv(tab_mean_costs_effects, "07_tables/Mean_Costs_Effects.csv")
write.csv(tab_mean_costs_effects, "07_tables/ICER.csv")
### Packages
library(colorspace)
### Cost-Effectiveness Acceptability Curve
colours <- rainnbow_hcl(12)
m_max <- apply(m_net_benefit, c(1,3), which.max)
### Cost-Effectiveness Acceptability Curve
colours <- rainnbow_hcl(12)
m_max <- apply(m_net_benefit, c(1,3), which.max)
plot(wtp_seq, apply(m_max == 2, 2, mean), type = "l",
ylim = c(0,1),
col = colours[1],
xlab = "Willingness-to-pay",
ylab = "Probability of Cost Effectiveness",
main = "Cost Effectiveness Acceptability Curve")
### Cost-Effectiveness Acceptability Curve
colours <- rainbow_hcl(12)
m_max <- apply(m_net_benefit, c(1,3), which.max)
plot(wtp_seq, apply(m_max == 2, 2, mean), type = "l",
ylim = c(0,1),
col = colours[1],
xlab = "Willingness-to-pay",
ylab = "Probability of Cost Effectiveness",
main = "Cost Effectiveness Acceptability Curve")
plot(wtp_seq, apply(m_max == 2, 2, mean), type = "l", lwd = 2,
ylim = c(0,1),
col = colours[1],
xlab = "Willingness-to-pay",
ylab = "Probability of Cost Effectiveness",
main = "Cost Effectiveness Acceptability Curve")
plot(wtp_seq, apply(m_max == 2, 2, mean), type = "l", lwd = 2,
ylim = c(0,1),
col = colours[1],
xlab = "Willingness-to-pay",
ylab = "Probability of Cost Effectiveness for Treatment 2",
main = "Cost Effectiveness Acceptability Curve")
plot(wtp_seq, m_ceaf[, 2], type = "l", lwd = 2,
ylim = c(0,1),
col = colours[1],
xlab = "Willingness-to-pay",
ylab = "Probability of Cost Effectiveness",
main = "Cost Effectiveness Acceptability Curve")
points(wtp_seq, m_ceaf[, 1], type = "l", col = colours[2], lwd = 2)
points(wtp_seq, m_ceaf[, 1], type = "l", col = colours[3], lwd = 2)
points(wtp_seq, m_ceaf[, 1], type = "l", col = colours[4], lwd = 2)
points(wtp_seq, m_ceaf[, 1], type = "l", col = colours[5], lwd = 2)
points(wtp_seq, m_ceaf[, 1], type = "l", col = colours[6], lwd = 2)
points(wtp_seq, m_ceaf[, 1], type = "l", col = colours[7], lwd = 2)
plot(wtp_seq, apply(m_max == 2, 2, mean), type = "l", lwd = 3,
ylim = c(0,1),
col = colours[1],
xlab = "Willingness-to-pay",
ylab = "Probability of Cost Effectiveness for Treatment 2",
main = "Cost Effectiveness Acceptability Curve")
pdf("05_figs/CEAC.pdf")
plot(wtp_seq, apply(m_max == 2, 2, mean), type = "l", lwd = 3,
ylim = c(0,1),
col = colours[1],
xlab = "Willingness-to-pay",
ylab = "Probability of Cost Effectiveness for Treatment 2",
main = "Cost Effectiveness Acceptability Curve")
dev.off()
plot(wtp_seq, m_ceaf[, 2], type = "l", lwd = 2,
ylim = c(0,1),
col = colours[1],
xlab = "Willingness-to-pay",
ylab = "Probability of Cost Effectiveness",
main = "Cost Effectiveness Acceptability Frontier")
points(wtp_seq, m_ceaf[, 1], type = "l", col = colours[7], lwd = 2)
?pch
points(wtp_seq, v_ceaf, pch = 19, cex = 0.5)
points(wtp_seq, v_ceaf, pch = 0)
### Packages
library(colorspace)
### Run the Model
source("04_analysis/01_model_run.R")
### Mean costs and effects
mean_costs_effects <- apply(m_costs_effects, 2, mean)
tab_mean_costs_effects <- matrix(mean_costs_effects, nrow = 2, ncol = 2)
colnames(tab_mean_costs_effects) <- c("Costs", "Effects")
rownames(tab_mean_costs_effects) <- c("Treatment 1", "Treatment 2")
write.csv(tab_mean_costs_effects, "07_tables/Mean_Costs_Effects.csv")
### Incremental Cost-Effectiveness Ratio (ICER)
ICER <- mean(m_costs_effects[, c("cost1")] - m_costs_effects[, c("cost2")]) /
mean(m_costs_effects[, c("eff1")] - m_costs_effects[, c("eff2")])
ICER
write.csv(tab_mean_costs_effects, "07_tables/ICER.csv")
### Cost-Effectiveness Acceptability Curve
colours <- rainbow_hcl(12)
m_max <- apply(m_net_benefit, c(1,3), which.max)
pdf("05_figs/CEAC.pdf")
plot(wtp_seq, apply(m_max == 2, 2, mean), type = "l", lwd = 3,
ylim = c(0,1),
col = colours[1],
xlab = "Willingness-to-pay",
ylab = "Probability of Cost Effectiveness for Treatment 2",
main = "Cost Effectiveness Acceptability Curve")
dev.off()
pdf("06_figs/CEAC.pdf")
plot(wtp_seq, apply(m_max == 2, 2, mean), type = "l", lwd = 3,
ylim = c(0,1),
col = colours[1],
xlab = "Willingness-to-pay",
ylab = "Probability of Cost Effectiveness for Treatment 2",
main = "Cost Effectiveness Acceptability Curve")
dev.off()
plot(wtp_seq, m_ceaf[, 2], type = "l", lwd = 3,
ylim = c(0,1),
col = colours[1],
xlab = "Willingness-to-pay",
ylab = "Probability of Cost Effectiveness",
main = "Cost Effectiveness Acceptability Frontier")
### Cost-Effectiveness Acceptability Frontier
m_ceaf <- cbind(apply(m_max == 1, 2, mean), apply(m_max == 2, 2, mean))
plot(wtp_seq, m_ceaf[, 2], type = "l", lwd = 3,
ylim = c(0,1),
col = colours[1],
xlab = "Willingness-to-pay",
ylab = "Probability of Cost Effectiveness",
main = "Cost Effectiveness Acceptability Frontier")
points(wtp_seq, m_ceaf[, 1], type = "l", col = colours[7], lwd = 3)
v_optimal_treatment <- apply(apply(m_net_benefit, c(2,3), mean), 2, which.max)
v_ceaf <- vector(length = n_wtp)
for(i in 1:n_wtp){
v_ceaf[i] <- m_ceaf[i, v_optimal_treatment[i]]
}
points(wtp_seq, v_ceaf, pch = 19, cex = 0.5)
points(wtp_seq, v_ceaf, pch = 0)
legend("bottomright", c("Treatment 1", "Treatment 2", "Frontier"),
lwd = c(2, 2, NULL), pch = c(NULL, NULL, 0),
col = c(colours[1], colours[7], "black"))
legend("bottomright", c("Treatment 1", "Treatment 2", "Frontier"),
lwd = c(2, 2, 0), pch = c(NULL, NULL, 0),
col = c(colours[1], colours[7], "black"))
legend("bottomright", c("Treatment 1", "Treatment 2", "Frontier"),
lwd = c(2, 2, 1), pch = c(NULL, NULL, 0),
col = c(colours[1], colours[7], NULL))
legend("bottomright", c("Treatment 1", "Treatment 2", "Frontier"),
lwd = c(2, 2, 1), pch = c(NA, NA, 0),
col = c(colours[1], colours[7], NA))
legend("bottomright", c("Treatment 1", "Treatment 2", "Frontier"),
lwd = c(2, 2, NA), pch = c(NA, NA, 0),
col = c(colours[1], colours[7], "black"))
m_ceaf <- cbind(apply(m_max == 1, 2, mean), apply(m_max == 2, 2, mean))
pdf("06_figs/CEAF.pdf")
plot(wtp_seq, m_ceaf[, 2], type = "l", lwd = 3,
ylim = c(0,1),
col = colours[1],
xlab = "Willingness-to-pay",
ylab = "Probability of Cost Effectiveness",
main = "Cost Effectiveness Acceptability Frontier")
points(wtp_seq, m_ceaf[, 1], type = "l", col = colours[7], lwd = 3)
v_optimal_treatment <- apply(apply(m_net_benefit, c(2,3), mean), 2, which.max)
v_ceaf <- vector(length = n_wtp)
for(i in 1:n_wtp){
v_ceaf[i] <- m_ceaf[i, v_optimal_treatment[i]]
}
points(wtp_seq, v_ceaf, pch = 19, cex = 0.5)
points(wtp_seq, v_ceaf, pch = 0)
legend("bottomright", c("Treatment 1", "Treatment 2", "Frontier"),
lwd = c(2, 2, NA), pch = c(NA, NA, 0),
col = c(colours[1], colours[7], "black"))
dev.off()
### Baseline willingness to pay = 20000
baseline_wtp <- which(wtp_seq == 20000)
baseline_wtp
# Average net benefit
mean_net_benefit <- apply(m_net_benefit[, , baseline_wtp], 2, mean)
mean_net_benefit
colnames(mean_net_benefit) <- c("Treatment 1", "Treatment 2")
names(mean_net_benefit) <- c("Treatment 1", "Treatment 2")
write.csv(tab_mean_costs_effects, "07_tables/Mean_Net_Benefit.csv")
# Optimal treatment
d_star <-  which.max(mean_net_benefit)
d_star
d_star
